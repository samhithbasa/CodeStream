<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeStream IDE</title>
    <link rel="stylesheet" href="css/code.css">
    <link rel="stylesheet" href="/js/codemirror-5.65.18/lib/codemirror.css">
    <script src="/js/codemirror-5.65.18/lib/codemirror.js"></script>
    <script src="/js/codemirror-5.65.18/addon/edit/closebrackets.js"></script>
    <script src="/js/codemirror-5.65.18/mode/clike/clike.js"></script>
    <script src="/js/codemirror-5.65.18/mode/python/python.js"></script>
    <script src="/js/codemirror-5.65.18/addon/hint/show-hint.js"></script>
    <script src="/js/codemirror-5.65.18/addon/hint/anyword-hint.js"></script>
    <link rel="stylesheet" href="/js/codemirror-5.65.18/addon/hint/show-hint.css">
    <!-- Lint Addon -->
    <link rel="stylesheet" href="/js/codemirror-5.65.18/addon/lint/lint.css">
    <script src="/js/codemirror-5.65.18/addon/lint/lint.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <link rel="stylesheet" href="/js/codemirror-5.65.18/theme/material-darker.css">
    <link rel="stylesheet" href="/js/codemirror-5.65.18/theme/solarized.css">
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css">
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
</head>

<body>
    <header>
        <img src="images/logo.jpg" id="logo">
        <div class="right">
            <button class="cm-solarized-btn cm-solarized-btn-primary" id="run-button">Run</button>
            <button class="cm-solarized-btn cm-solarized-btn-secondary" id="save-button">Save</button>
            <input type="text" id="code-name" placeholder="Enter code name">
            <button class="cm-solarized-btn cm-solarized-btn-code" id="show-saved">Saved Codes</button>
            <div id="saved-codes-popup">
                <ul id="saved-code-list"></ul>
            </div>
            <button class="cm-solarized-btn cm-solarized-btn-logout" id="logout-button">Logout</button>
            <img src="images/moon.png" id="moon">
        </div>
    </header>

    <section>
        <div class="icons">
            <img src="images/c.png" id="c">
            <img src="images/c++.png" id="c++">
            <img src="images/java.png" id="java">
            <img src="images/python.png" id="python">
        </div>

        <div class="code-editor">
            <textarea id="code"></textarea>
        </div>

        <div class="preview">
            <div class="terminal-container">
                <label>Terminal</label>
                <div id="terminal"></div>
            </div>
        </div>
    </section>

    <div id="copy-notification" class="copy-notification">
        <span>‚úì</span> The Link is Copied to clipboard
    </div>

    <div id="save-popup-overlay" class="popup-overlay">
        <div class="popup-container">
            <div class="popup-header">
                <h2>Save Your Code</h2>
                <button class="popup-close">&times;</button>
            </div>
            <div class="popup-body">
                <input type="text" id="save-popup-name" placeholder="Enter code name" class="popup-input">
            </div>
            <div class="popup-footer">
                <button id="save-popup-button" class="popup-save-btn">SAVE</button>
            </div>
        </div>
    </div>

    <script>
        const body = document.body;
        const moon = document.getElementById('moon');
        const showSavedButton = document.getElementById('show-saved');
        const savedCodesPopup = document.getElementById('saved-codes-popup');
        const logoutButton = document.getElementById('logout-button');
        let isDark = localStorage.getItem('theme') === 'dark';
        let activeModal = null;
        let currentUser = null;

        // Initialize terminal
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Consolas, "Liberation Mono", Menlo, Courier, monospace',
            theme: {
                background: '#1e1e1e',
                foreground: '#ffffff',
                cursor: '#ffffff',
                cursorAccent: '#000000'
            }
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        // Handle window resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
        });


        // WebSocket connection
        let socket = null;
        let isWaitingForInput = false;
        let currentInputLine = '';
        let inputPrompt = '';

        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode: "text/x-c++src",
            theme: "material-darker",
            lineNumbers: true,
            autoCloseBrackets: true,
            extraKeys: { "Ctrl-Space": "autocomplete" },
            lint: {
                getAnnotations: CodeMirror.asyncLint,
                async: true
            },
            gutters: ["CodeMirror-lint-markers"]
        });

        // Custom Linting Logic
        CodeMirror.asyncLint = function (content, update, options, cm) {
            fetch('/lint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: content, lang: selectedLanguage })
            })
                .then(res => res.json())
                .then(data => {
                    const annotations = data.errors.map(err => ({
                        from: CodeMirror.Pos(err.line, err.column),
                        to: CodeMirror.Pos(err.line, err.column + 1),
                        message: err.message,
                        severity: err.severity || "error"
                    }));
                    update(cm, annotations);
                })
                .catch(err => {
                    console.error("Linting error:", err);
                    update(cm, []);
                });
        };

        // Autocomplete on type
        editor.on("keyup", function (cm, event) {
            if (!cm.state.completionActive &&
                event.keyCode >= 65 && event.keyCode <= 90 || // A-Z
                event.keyCode == 190 || // .
                event.keyCode == 186) { // :
                CodeMirror.commands.autocomplete(cm, null, { completeSingle: false });
            }
        });

        const langKeywords = {
            'C': ["auto", "break", "case", "char", "const", "continue", "default", "do", "double", "else", "enum", "extern", "float", "for", "goto", "if", "int", "long", "register", "return", "short", "signed", "sizeof", "static", "struct", "switch", "typedef", "union", "unsigned", "void", "volatile", "while"],
            'Cpp': ["auto", "break", "case", "char", "const", "continue", "default", "do", "double", "else", "enum", "extern", "float", "for", "goto", "if", "int", "long", "register", "return", "short", "signed", "sizeof", "static", "struct", "switch", "typedef", "union", "unsigned", "void", "volatile", "while", "class", "public", "private", "protected", "namespace", "using", "template", "typename", "virtual", "override", "std", "cout", "cin", "endl"],
            'Python': ["False", "None", "True", "and", "as", "assert", "async", "await", "break", "class", "continue", "def", "del", "elif", "else", "except", "finally", "for", "from", "global", "if", "import", "in", "is", "lambda", "nonlocal", "not", "or", "pass", "raise", "return", "try", "while", "with", "yield", "print", "input", "range", "len", "type"],
            'Java': ["abstract", "assert", "boolean", "break", "byte", "case", "catch", "char", "class", "const", "continue", "default", "do", "double", "else", "enum", "extends", "final", "finally", "float", "for", "goto", "if", "implements", "import", "instanceof", "int", "interface", "long", "native", "new", "package", "private", "protected", "public", "return", "short", "static", "strictfp", "super", "switch", "synchronized", "this", "throw", "throws", "transient", "try", "void", "volatile", "while", "System", "out", "println"]
        };

        CodeMirror.registerHelper("hint", "anyword", function (editor, options) {
            const word = /[\w$]+/;
            const cur = editor.getCursor(), curLine = editor.getLine(cur.line);
            const end = cur.ch, start = end;
            while (start && word.test(curLine.charAt(start - 1))) --start;
            const curWord = start != end && curLine.slice(start, end);

            const list = [];
            const keywords = langKeywords[selectedLanguage] || [];

            // Add language keywords
            keywords.forEach(kw => {
                if (kw.startsWith(curWord || "")) list.push(kw);
            });

            // Add words from the editor itself (existing anyword-hint behavior)
            const re = new RegExp(word.source, "g");
            for (let i = 0; i < editor.lineCount(); i++) {
                const line = editor.getLine(i);
                let m;
                while (m = re.exec(line)) {
                    if (i != cur.line || m[0] != curWord) {
                        if (m[0].startsWith(curWord || "") && !list.includes(m[0])) {
                            list.push(m[0]);
                        }
                    }
                }
            }

            return { list: list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end) };
        });

        const input = document.getElementById("input-box");
        const output = document.getElementById("output-box");
        const run = document.getElementById("run-button");
        const save = document.getElementById("save-button");
        const codeNameInput = document.getElementById("code-name");
        const savedCodeList = document.getElementById("saved-code-list");
        const savePopupOverlay = document.getElementById('save-popup-overlay');
        const savePopupName = document.getElementById('save-popup-name');
        const savePopupButton = document.getElementById('save-popup-button');
        const closePopup = document.querySelector('.popup-close');

        const languageModes = {
            'c': { mode: 'text/x-csrc', lang: 'C' },
            'c++': { mode: 'text/x-c++src', lang: 'Cpp' },
            'java': { mode: 'text/x-java', lang: 'Java' },
            'python': { mode: 'text/x-python', lang: 'Python' }
        };
        let selectedLanguage = 'Cpp';

        const updateTheme = (isDark) => {
            const editorTheme = isDark ? 'material-darker' : 'solarized';
            editor.setOption("theme", editorTheme);
            document.documentElement.style.setProperty(
                '--accent-danger',
                isDark ? '#ff5370' : '#dc322f'
            );
        };

        moon.addEventListener('click', () => {
            isDark = !isDark;
            body.classList.toggle('dark-theme', isDark);
            moon.src = isDark ? 'images/sun.webp' : 'images/moon.png';
            updateTheme(isDark);
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        document.addEventListener("DOMContentLoaded", async () => {
            // 1. Initialize Theme
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            isDark = savedTheme ? (savedTheme === 'dark') : systemDark;
            body.classList.toggle('dark-theme', isDark);
            moon.src = isDark ? 'images/sun.webp' : 'images/moon.png';
            editor.setOption("theme", isDark ? 'material-darker' : 'solarized');

            // 2. Initialize UI Defaults
            if (document.getElementById("c++")) {
                document.getElementById("c++").classList.add('active-language');
            }

            // 3. Handle Google Auth Redirect (Token in URL)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (token) {
                console.log("Found token in URL, setting cookie...");
                const isSecure = window.location.protocol === 'https:';
                Cookies.set('token', token, {
                    expires: 7,
                    path: '/',
                    secure: isSecure,
                    sameSite: 'lax'
                });

                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);

                // Restore pending code if any
                restorePendingCode();
            }

            // 4. Verify Auth Status & Load Data
            await verifyAuthStatus();
            checkRedirectAfterLogin();

            if (currentUser) {
                loadSavedCodes();
            }
        });

        function restorePendingCode() {
            const pending = sessionStorage.getItem('pendingCode');
            if (pending) {
                try {
                    const { code, lang } = JSON.parse(pending);
                    if (editor && editor.setValue) editor.setValue(code || '');

                    if (lang && languageModes) {
                        const key = ({ 'Cpp': 'c++', 'C': 'c', 'Java': 'java', 'Python': 'python' })[lang] || 'c++';
                        if (languageModes[key]) {
                            selectedLanguage = languageModes[key].lang;
                            editor.setOption('mode', languageModes[key].mode);
                            document.querySelectorAll('.icons img').forEach(img => img.classList.remove('active-language'));
                            const icon = document.getElementById(key);
                            if (icon) icon.classList.add('active-language');
                        }
                    }
                    sessionStorage.removeItem('pendingCode');
                    if (typeof showNotification === 'function') showNotification('Logged in! You can save your code now.');
                    if (typeof showSavePopup === 'function') showSavePopup();
                } catch (e) { console.error("Error restoring code:", e); }
            }
        }



        // Add this function to code.html script section
        function showEditorSelectionPopup() {
            console.log('DEBUG: showEditorSelectionPopup called from code editor');

            // Create popup overlay
            const popupOverlay = document.createElement('div');
            popupOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(10px);
    `;

            const popupContent = document.createElement('div');
            popupContent.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        color: white;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
    `;

            popupContent.innerHTML = `
        <h2 style="margin-bottom: 10px; font-size: 2rem;">üéâ Welcome to Code Editor!</h2>
        <p style="margin-bottom: 15px; opacity: 0.9;">Would you like to switch to Frontend Playground?</p>
        
        <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: left; border-left: 4px solid #ffd700;">
            <h4 style="margin: 0 0 10px 0; color: #ffd700;">üìù Important Notes:</h4>
            <div style="font-size: 0.9rem; line-height: 1.5;">
                <div style="margin-bottom: 10px;">
                    <strong>üîß For Frontend Playground:</strong>
                    <ul style="margin: 5px 0 5px 20px; padding: 0;">
                        <li>Write JavaScript functions globally</li>
                        <li>Build complete web projects</li>
                        <li>Live preview and deployment</li>
                    </ul>
                </div>
                <div>
                    <strong>‚òï For Code Editor (Java/C++/Python):</strong>
                    <ul style="margin: 5px 0 0 20px; padding: 0;">
                        <li>Write, compile and run code</li>
                        <li>Multiple programming languages</li>
                        <li>Integrated terminal</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button id="stay-here" style="
                background: rgba(255, 255, 255, 0.2); 
                color: white; 
                border: 1px solid rgba(255, 255, 255, 0.3); 
                padding: 12px 30px; 
                border-radius: 25px; 
                cursor: pointer; 
                font-size: 1rem;
                transition: all 0.3s ease;
                min-width: 150px;
            ">Stay Here</button>
            <button id="go-to-frontend" style="
                background: rgba(255, 255, 255, 0.9); 
                color: #667eea; 
                border: none; 
                padding: 12px 30px; 
                border-radius: 25px; 
                cursor: pointer; 
                font-size: 1rem; 
                font-weight: bold;
                transition: all 0.3s ease;
                min-width: 150px;
            ">Go to Frontend Playground</button>
        </div>
        
        <p style="margin-top: 20px; font-size: 0.8rem; opacity: 0.7;">
            <strong>Tip:</strong> You can switch between editors anytime using the navigation menu.
        </p>
    `;

            popupOverlay.appendChild(popupContent);
            document.body.appendChild(popupOverlay);

            // Add hover effects
            const stayBtn = document.getElementById('stay-here');
            const goBtn = document.getElementById('go-to-frontend');

            stayBtn.addEventListener('mouseenter', () => {
                stayBtn.style.background = 'rgba(255, 255, 255, 0.3)';
                stayBtn.style.transform = 'translateY(-2px)';
            });

            stayBtn.addEventListener('mouseleave', () => {
                stayBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                stayBtn.style.transform = 'translateY(0)';
            });

            goBtn.addEventListener('mouseenter', () => {
                goBtn.style.background = 'rgba(255, 255, 255, 1)';
                goBtn.style.transform = 'translateY(-2px)';
                goBtn.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)';
            });

            goBtn.addEventListener('mouseleave', () => {
                goBtn.style.background = 'rgba(255, 255, 255, 0.9)';
                goBtn.style.transform = 'translateY(0)';
                goBtn.style.boxShadow = 'none';
            });

            // Add event listeners
            stayBtn.addEventListener('click', function () {
                console.log('DEBUG: User chose to stay on Code Editor');
                document.body.removeChild(popupOverlay);

                // Show confirmation
                showNotification('‚úì Staying on Code Editor');
            });

            goBtn.addEventListener('click', function () {
                console.log('DEBUG: User chose to go to Frontend Playground');

                // Add loading effect
                goBtn.innerHTML = '‚è≥ Redirecting...';
                goBtn.disabled = true;
                goBtn.style.opacity = '0.7';

                setTimeout(() => {
                    window.location.href = '/frontend-editor.html';
                }, 500);
            });

            // Close on overlay click
            popupOverlay.addEventListener('click', function (e) {
                if (e.target === popupOverlay) {
                    document.body.removeChild(popupOverlay);
                }
            });

            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    `;
            document.head.appendChild(style);
        }

        // Add notification function
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        animation: slideInRight 0.3s ease;
        z-index: 10001;
    `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        document.querySelectorAll('.icons img').forEach(icon => {
            icon.addEventListener('click', () => {
                document.querySelectorAll('.icons img').forEach(img => img.classList.remove('active-language'));
                icon.classList.add('active-language');
                let { mode, lang } = languageModes[icon.id];
                editor.setOption('mode', mode);
                selectedLanguage = lang;
            });
        });

        run.addEventListener("click", () => {
            // Clear terminal
            term.clear();
            isProcessReady = false;
            currentInputLine = '';

            // Close existing connection if any
            if (socket) {
                socket.close();
            }

            // Create new WebSocket connection
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/terminal`);

            socket.onopen = () => {
                term.write('\r\n\x1b[32m‚óè Connected to terminal\x1b[0m\r\n');
                term.write('\x1b[33m‚óè Running your program...\x1b[0m\r\n\r\n');

                // Send execution command
                socket.send(JSON.stringify({
                    type: 'execute',
                    code: editor.getValue(),
                    lang: selectedLanguage
                }));
            };

            socket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);

                    switch (message.type) {
                        case 'output':
                            term.write(message.data);
                            // If we see output with prompts, the program is ready for input
                            if (message.data.includes('Enter') || message.data.includes(':')) {
                                isProcessReady = true;
                                term.write('\r\n\x1b[36m‚óè Type your input and press ENTER: \x1b[0m');
                            }
                            break;

                        case 'program_running':
                            isProcessReady = true;
                            break;

                        case 'exit':
                            isProcessReady = false;
                            currentInputLine = '';
                            term.write('\r\n\x1b[33m‚óè Program execution completed\x1b[0m\r\n');
                            break;
                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            socket.onclose = () => {
                isProcessReady = false;
                currentInputLine = '';
                term.write('\r\n\x1b[31m‚óè Connection closed\x1b[0m\r\n');
            };

            socket.onerror = (error) => {
                isProcessReady = false;
                currentInputLine = '';
                term.write('\r\n\x1b[31m‚óè Connection error\x1b[0m\r\n');
                console.error('WebSocket error:', error);
            };
        });


        // Handle terminal input
        term.onData((data) => {
            if (socket && socket.readyState === WebSocket.OPEN && isProcessReady) {
                if (data === '\r' || data === '\n') { // Enter key
                    // Send the complete input line when Enter is pressed
                    socket.send(JSON.stringify({
                        type: 'input',
                        data: currentInputLine + '\n'
                    }));
                    term.write('\r\n');
                    currentInputLine = '';
                } else if (data === '\x7f' || data === '\b') { // Backspace
                    if (currentInputLine.length > 0) {
                        currentInputLine = currentInputLine.slice(0, -1);
                        term.write('\b \b');
                    }
                } else if (data === '\x03') { // Ctrl+C
                    socket.send(JSON.stringify({
                        type: 'input',
                        data: '\x03'
                    }));
                    term.write('^C\r\n');
                    currentInputLine = '';
                } else if (data >= ' ' && data <= '~') { // Printable characters
                    currentInputLine += data;
                    term.write(data);
                }
            }
        });

        term.attachCustomKeyEventHandler((event) => {
            if (event.ctrlKey && event.key === 'c' && isWaitingForInput) {
                // Handle Ctrl+C to interrupt
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'input',
                        data: '\x03'
                    }));
                    term.write('^C\r\n');
                    isWaitingForInput = false;
                    currentInputLine = '';
                    inputPrompt = '';
                    return false;
                }
            }
            return true;
        });

        term.onKey(({ key, domEvent }) => {
            if (domEvent.key === 'Enter') {
                if (socket && socket.readyState === WebSocket.OPEN && isWaitingForInput) {
                    // Send the Enter key as input
                    socket.send(JSON.stringify({
                        type: 'input',
                        data: '\n'
                    }));
                    term.write('\r\n');
                }
            }
        });


        function showSavePopup() {
            // Check authentication first
            const token = Cookies.get('token');
            if (!token) {
                window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname || '/code.html')}&source=code-editor`;
                return;
            }

            savePopupOverlay.style.display = 'flex';
            savePopupName.focus();
        }

        function hideSavePopup() {
            savePopupOverlay.style.display = 'none';
            savePopupName.value = '';
        }

        closePopup.addEventListener('click', hideSavePopup);
        savePopupOverlay.addEventListener('click', (e) => {
            if (e.target === savePopupOverlay) {
                hideSavePopup();
            }
        });

        savePopupButton.addEventListener('click', async () => {
            const name = savePopupName.value.trim();

            // Check authentication first
            const token = Cookies.get('token');
            if (!token) {
                window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname || '/code.html')}&source=code-editor`;
                return;
            }

            if (!name) {
                showNotification('Please enter a name for your code.', true);
                return;
            }
            await saveCurrentCode(name);
            codeNameInput.value = '';
            hideSavePopup();
        });

        save.addEventListener("click", async (e) => {
            e.preventDefault();
            const name = codeNameInput.value.trim();

            // Check authentication first
            const token = Cookies.get('token');
            if (!token) {
                window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname || '/code.html')}&source=code-editor`;
                return;
            }

            if (name) {
                await saveCurrentCode(name);
                codeNameInput.value = '';
            } else {
                showSavePopup();
            }
        });

        showSavedButton.addEventListener('click', (e) => {
            e.stopPropagation();
            savedCodesPopup.classList.toggle('show-popup');
        });

        document.addEventListener('click', (e) => {
            if (!savedCodesPopup.contains(e.target) && e.target !== showSavedButton) {
                savedCodesPopup.classList.remove('show-popup');
            }
        });



        async function verifyAuthStatus() {
            const token = Cookies.get('token');
            if (!token) {
                logoutButton.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/verify-token', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    logoutButton.style.display = 'block';
                } else {
                    Cookies.remove('token', { path: '/' });
                    currentUser = null;
                    logoutButton.style.display = 'none';
                }
            } catch (error) {
                console.error('Auth verification failed:', error);
                Cookies.remove('token', { path: '/' });
                currentUser = null;
                logoutButton.style.display = 'none';
            }
        }

        logoutButton.addEventListener('click', async () => {
            try {
                const token = Cookies.get('token');
                if (token) {
                    await fetch('/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                }

                Cookies.remove('token', { path: '/' });
                window.location.href = '/landing.html';
            } catch (error) {
                console.error('Logout failed:', error);
                alert('Logout failed. Please try again.');
            }
        });

        async function saveCurrentCode(name) {
            const token = Cookies.get('token');

            if (!token) {
                console.log('DEBUG: No token found, redirecting to login');

                // Store the code content temporarily before redirect
                const pendingCode = {
                    code: editor.getValue(),
                    lang: selectedLanguage,
                    name: name
                };

                // Store in sessionStorage
                sessionStorage.setItem('pendingCode', JSON.stringify(pendingCode));

                // Redirect to login with return URL
                const currentUrl = encodeURIComponent('/code.html');
                window.location.href = `/login.html?redirect=${currentUrl}&source=code-editor`;
                return;
            }

            const codeData = {
                code: editor.getValue(),
                lang: selectedLanguage,
                name: name
            };

            try {
                const response = await fetch("/save-code", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(codeData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Error saving code:", errorData);
                    showNotification("Failed to save code: " + errorData.error, true);
                    return;
                }

                const result = await response.json();
                showNotification(`Code saved as: ${result.name}`);
                loadSavedCodes();
            } catch (error) {
                console.error("Error saving code:", error);
                showNotification("Failed to save code", true);
            }
        }
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `save-notification ${isError ? 'error' : 'success'}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function showLoginModal(codeNameToSave = '') {
            if (activeModal) {
                closeLoginModal();
            }

            const loginModal = document.createElement('div');
            loginModal.id = 'login-modal';
            loginModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Login</h2>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="modal-login-form">
                            <div class="form-group">
                                <label for="modal-email">Email</label>
                                <input type="email" id="modal-email" placeholder="Enter your email" required>
                            </div>
                            <div class="form-group">
                                <label for="modal-password">Password</label>
                                <input type="password" id="modal-password" placeholder="Enter your password" required>
                            </div>
                            <button type="submit" class="login-btn">Login</button>
                        </form>
                        <div class="auth-links">
                            <a href="#" id="modal-forgot-password">Forgot Password?</a>
                            <div class="register-link">
                                Don't have an account? <a href="/register.html" id="register">Register here</a>
                            </div>
                        </div>
                    </div>
                    <div id="modal-message" class="modal-message"></div>
                    <input type="hidden" id="pending-code-name" value="${codeNameToSave}">
                </div>
            `;
            document.body.appendChild(loginModal);
            activeModal = loginModal;

            document.querySelector('.modal-close').addEventListener('click', closeLoginModal);

            loginModal.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    closeLoginModal();
                }
            });

            document.getElementById('modal-login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('modal-email').value;
                const password = document.getElementById('modal-password').value;
                const messageDiv = document.getElementById('modal-message');
                const pendingCodeName = document.getElementById('pending-code-name').value;

                messageDiv.textContent = '';
                messageDiv.className = 'modal-message';

                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        Cookies.set('token', data.token, { expires: 7 });
                        messageDiv.textContent = 'Login successful!';
                        messageDiv.classList.add('success');
                        currentUser = data.user;

                        setTimeout(() => {
                            closeLoginModal();
                            if (pendingCodeName) {
                                saveCurrentCode(pendingCodeName);
                            }
                            loadSavedCodes();
                        }, 1000);
                    } else {
                        messageDiv.textContent = data.error || 'Login failed';
                        messageDiv.classList.add('error');
                    }
                } catch (error) {
                    messageDiv.textContent = 'Network error. Please try again.';
                    messageDiv.classList.add('error');
                }
            });

            document.getElementById('modal-forgot-password').addEventListener('click', async (e) => {
                e.preventDefault();
                const email = document.getElementById('modal-email').value;
                const messageDiv = document.getElementById('modal-message');

                if (!email) {
                    messageDiv.textContent = 'Please enter your email first';
                    messageDiv.classList.add('error');
                    return;
                }

                try {
                    const response = await fetch('/forgot-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        messageDiv.textContent = data.message;
                        messageDiv.classList.add('success');
                    } else {
                        messageDiv.textContent = data.error;
                        messageDiv.classList.add('error');
                    }
                } catch (error) {
                    messageDiv.textContent = 'Error processing your request';
                    messageDiv.classList.add('error');
                }
            });
        }

        function closeLoginModal() {
            if (activeModal) {
                document.body.removeChild(activeModal);
                activeModal = null;
            }
        }

        async function loadSavedCodes() {
            try {
                const token = Cookies.get('token');

                if (!savedCodeList) {
                    console.error('Saved codes list element not found');
                    return;
                }

                savedCodeList.innerHTML = '<li class="loading">Loading your codes...</li>';

                if (!token || !currentUser) {
                    savedCodeList.innerHTML = '<li>Please login to view saved codes</li>';
                    return;
                }

                const response = await fetch("/saved-codes", {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    Cookies.remove('token');
                    currentUser = null;
                    savedCodeList.innerHTML = '<li>Session expired. Please login again.</li>';
                    return;
                }

                const codes = await response.json();
                savedCodeList.innerHTML = "";

                if (!codes || codes.length === 0) {
                    savedCodeList.innerHTML = '<li>No saved codes yet. Start by saving your first code!</li>';
                    return;
                }

                codes.forEach(code => {
                    const listItem = document.createElement("li");
                    listItem.dataset.id = code.id;
                    listItem.innerHTML = `
                <div class="code-info">
                    <span class="code-name">${code.name}</span>
                    <span class="code-lang">${code.lang}</span>
                </div>
                <div class="code-actions">
                    <button class="load-btn" title="Load this code">‚Üª</button>
                    <button class="share-btn" title="Share this code">üîó</button>
                    <button class="delete-btn" title="Delete this code">üóëÔ∏è</button>
                </div>
            `;

                    listItem.querySelector('.load-btn').addEventListener('click', () => loadCode(code.id));
                    listItem.querySelector('.share-btn').addEventListener('click', (e) => shareCode(e, code.id));
                    listItem.querySelector('.delete-btn').addEventListener('click', (e) => deleteCode(e, code.id));

                    savedCodeList.appendChild(listItem);
                });
            } catch (error) {
                console.error("Failed to load saved codes:", error);
                savedCodeList.innerHTML = `
            <li class="error">
                Failed to load codes. 
                <button onclick="loadSavedCodes()">Retry</button>
            </li>
        `;
            }
        }

        async function loadCode(codeId) {
            try {
                const token = Cookies.get('token');
                const response = await fetch(`/get-code/${codeId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load code');

                const codeData = await response.json();
                editor.setValue(codeData.code);
                document.getElementById('code-name').value = codeData.name;

                const langIcon = Object.entries(languageModes).find(
                    ([_, value]) => value.lang === codeData.lang
                )?.[0];

                if (langIcon) {
                    document.querySelectorAll('.icons img').forEach(img =>
                        img.classList.remove('active-language'));
                    document.getElementById(langIcon).classList.add('active-language');
                    selectedLanguage = codeData.lang;
                    editor.setOption('mode', languageModes[langIcon].mode);
                }

            } catch (error) {
                console.error('Error loading code:', error);
                alert('Failed to load code: ' + error.message);
            }
        }

        async function shareCode(event, codeId) {
            event.stopPropagation();
            const token = Cookies.get('token');

            if (!token) {
                window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname || '/code.html')}&source=code-editor`;
                return;
            }

            try {
                const response = await fetch(`/share-code/${codeId}`, {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Sharing failed');

                const { shareId } = await response.json();
                const shareLink = `${window.location.origin}/shared/${shareId}`;

                await navigator.clipboard.writeText(shareLink);
                showCopyNotification();

            } catch (error) {
                console.error('Sharing failed:', error);
                alert('Failed to share code: ' + error.message);
            }
        }

        async function deleteCode(event, codeId) {
            event.stopPropagation();

            const token = Cookies.get('token');
            if (!token) {
                window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname || '/code.html')}&source=code-editor`;
                return;
            }

            if (!confirm("Are you sure you want to delete this code?")) return;

            try {
                const response = await fetch(`/delete-code/${codeId}`, {
                    method: "DELETE",
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Deletion failed');

                event.target.closest('li').remove();

                if (savedCodeList.children.length === 0) {
                    savedCodeList.innerHTML = '<li>No saved codes yet. Start by saving your first code!</li>';
                }

            } catch (error) {
                console.error('Error deleting code:', error);
                alert('Failed to delete code: ' + error.message);
            }
        }

        function showCopyNotification() {
            const notification = document.getElementById('copy-notification');
            notification.style.display = 'flex';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        function checkRedirectAfterLogin() {
            const urlParams = new URLSearchParams(window.location.search);
            const justLoggedIn = urlParams.get('justLoggedIn');

            if (justLoggedIn === 'true') {
                // Remove the parameter from URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);

                // Show welcome message
                showNotification('Welcome back! You can now save your code.', false);
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            #login-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                backdrop-filter: blur(5px);
            }
            
            .modal-content {
                background: white;
                border-radius: 10px;
                width: 100%;
                max-width: 400px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                overflow: hidden;
                animation: modalFadeIn 0.3s ease-out;
            }
            
            @keyframes modalFadeIn {
                from { opacity: 0; transform: translateY(-20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .modal-header {
                background: linear-gradient(135deg, #6e8efb, #a777e3);
                color: white;
                padding: 20px;
                text-align: center;
                position: relative;
            }
            
            .modal-header h2 {
                margin: 0;
                font-size: 1.5rem;
            }
            
            .modal-close {
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                transition: transform 0.2s;
            }
            
            .modal-close:hover {
                transform: scale(1.2);
            }
            
            .modal-body {
                padding: 25px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: #555;
            }
            
            .form-group input {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 1rem;
                transition: border-color 0.3s;
            }
            
            .form-group input:focus {
                border-color: #6e8efb;
                outline: none;
                box-shadow: 0 0 0 3px rgba(110, 142, 251, 0.2);
            }
            
            .login-btn {
                width: 100%;
                padding: 12px;
                background: linear-gradient(135deg, #ÊûÅÈÄüÁîµÁ´û, #a777e3);
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .login-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(110, 142, 251, 0.4);
            }
            
            .auth-links {
                margin-top: 20px;
                text-align: center;
                font-size: 0.9rem;
            }
            
            #modal-forgot-password {
                color: #6e8efb;
                text-decoration: none;
                display: inline-block;
                margin-bottom: 15px;
            }
            
            .register-link {
                color: #666;
            }
            
            #register {
                color: #6e8efb;
                text-decoration: none;
                font-weight: 500;
            }
            
            .modal-message {
                padding: 15px;
                margin: 0 25px 25px;
                border-radius: 6px;
                text-align: center;
                display: none;
            }
            
            .modal-message.success {
                background-color: #e6ffed;
                color: #2d8a4a;
                display: block;
            }
            
            .modal-message.error {
                background-color: #ffebee;
                color: #c62828;
                display: block;
            }
            
            /* Dark theme support */
            .dark-theme .modal-content {
                background: #2d3748;
                color: #f7fafc;
            }
            
            .dark-theme .form-group label {
                color: #e2e8f0;
            }
            
            .dark-theme .form-group input {
                background-color: #4a5568;
                border-color: #4a5568;
                color: #f7fafc;
            }
            
            .dark-theme .form-group input:focus {
                border-color: #6e8efb;
            }
            
            .dark-theme .register-link {
                color: #cbd5e0;
            }
        `;
        document.head.appendChild(style);

        window.addEventListener('resize', () => {
            fitAddon.fit();
        });

    </script>
</body>



</html>